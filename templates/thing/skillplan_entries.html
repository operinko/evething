{% extends "base.html" %}
{% import 'macros/common.html' as common %}
{% import 'macros/icons.html' as icons %}


{% block extra_js %}
    <script type="text/javascript">
        // current skill popover displayed
        var current_popover_id = false;
        
        $(function() {
        
            // hover thing for skill descriptions
            $('.skill-hover').popover({ 
                animation: false, 
                trigger: 'click', 
                html: true,
                placement: 'left',
                container: 'body'
            }).on('click', 
                function() {
                    // popover on click, but only display one popover.
                    if(current_popover_id) {
                        if(current_popover_id != $(this).attr('id')) {
                            $('#'+current_popover_id).popover('hide');
                        }
                    }
                    current_popover_id=$(this).attr('id');
                    
                    // define click events on button in the popover        
                    $('.btn-plan-skill').on('click',
                        function() {
                            var plan_to_level   = $(this).attr('data-level');
                            var plan_skill_id   = $(this).attr('data-id');
                            addSkillInPlan(plan_skill_id, plan_to_level);
                        }
                    );
                }
            );;
            

            
        });
        
        function addRemapPoint() {
            return false;
        }
        
        function addSkillInPlan(skill_id, level) {
            $.ajax({
                crossDomain: false,
                url: '{{ url('thing.views.skillplan_add_skill') }}',
                data: { action:'getprerequisite'
                      , skill_id:skill_id
                      , skillplan_id:{{ skillplan.id }} },
                type:'post',
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", $.cookie('csrftoken'));
                },
                success: function(json) {
                    //alert(json)
                    // TODO : read the json and add the new skills into the plan.
                    skills = $.parseJSON(json);
                    $('#'+current_popover_id).popover('hide');
                },
                error: function(xhr, status, error) {
                    //alert(status);
                }
            });
        }
        
        function optimizeAttributes() {
        
        }
        
        function optimizeRemaps() {
        
        }
    </script>
{% endblock %}


{% block title %}Skill Plan{% endblock %}

{% block content %}    
<div class="row-fluid">
    <div class="span9">
        <div class="row-fluid">
            <div class="span12">
                <form class="form-inline well well-small" action="">
                    <div class="margin-half-bot">
                        <strong class="large">Skillplan : {{ skillplan.name }}</strong>
                    </div>

                    <div class="pull-right">
                        <div class="btn-group">
                            <a class="btn dropdown-toggle btn-success" data-toggle="dropdown" href="#">
                                Optimize
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="#">Attributes</a></li>
                                <li><a href="#">Remap</a></li>
                                <!-- dropdown menu links -->
                            </ul>
                        </div>
                        &nbsp;
                        <a  href="#" class="btn btn-info">Add Remap</a>
                    </div>
                    
                    <label class="select">
                        <select name="character">
                            <option value="-1">New Character (no remap)</option>
                            {% for character in characters -%}
                            <option value="{{ character.id }}" {% if selected_character and selected_character.id == character.id %}selected="selected"{% endif %}>{{ character.name }}</option>
                            {%- endfor %}
                        </select>
                    </label>
                    &nbsp;
                    <label class="select">
                        <select name="implants">
                            <option value="0"{% if implants == 0 %} selected{% endif %}>
                                {% if selected_character %}Character implants{% else %}No implants{% endif %}
                            </option>
                            <option value="2"{% if implants == 2 %} selected{% endif %}>+2 implants</option>
                            <option value="3"{% if implants == 3 %} selected{% endif %}>+3 implants</option>
                            <option value="4"{% if implants == 4 %} selected{% endif %}>+4 implants</option>
                            <option value="5"{% if implants == 5 %} selected{% endif %}>+5 implants</option>
                        </select>
                    </label>
                    &nbsp;
                    <label class="checkbox">
                        <input type="checkbox" name="show_trained"{% if show_trained %} checked{% endif %}> Show already trained skills
                    </label>
                    &nbsp;
                    <button type="submit" class="btn btn-primary">Apply</button>
                    
                </form>
            </div>
        </div>
        
        <div class="row-fluid">
            <div class="span12">
                <table id="skillplan" class="table table-striped table-bordered table-condensed">
                    <thead>
                        <tr class="c">
                            <th></th>
                            <th>Skill</th>
                            <th>Group</th>
                            <th>Pri</th>
                            <th>Sec</th>
                            <th>SP/hr</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for entry in entries -%}
                        <tr class="c">
                        {% if entry.sp_remap -%}
                            <td></td>
                            <td class="l" colspan="6">
                                <i class="icon-user"></i> Remap to
                                <strong>{{ entry.sp_remap.int_stat }}</strong> Int /
                                <strong>{{ entry.sp_remap.mem_stat }}</strong> Mem /
                                <strong>{{ entry.sp_remap.per_stat }}</strong> Per /
                                <strong>{{ entry.sp_remap.wil_stat }}</strong> Wil /
                                <strong>{{ entry.sp_remap.cha_stat }}</strong> Cha
                            </td>
                        {%- else %}
                            <td class="sp-trained">
                            {% if entry.z_training -%}
                                <i class="icon-flag"></i>
                            {%- else -%}
                                {{ icons.success_fail(entry.z_trained) }}
                            {%- endif %}
                            </td>
                            <td class="l{% if entry.z_training %} training-highlight{% endif %}">
                                {{ common.skill_hover(entry.sp_skill.skill, entry.sp_skill.level)}}
                                {% if entry.z_injected -%}
                                <i class="icon-book pull-right" rel="tooltip" title="Skillbook is injected"</i>
                                {%- elif entry.z_buy %}
                                <i class="icon-shopping-cart pull-right" rel="tooltip" title="Skillbook is not injected"</i>
                                {%- endif %}
                            </td>
                            <td class="sp-group">{{ entry.sp_skill.skill.item.item_group }}</td>
                            <td class="sp-small">{{ entry.sp_skill.skill.get_primary_attribute_display() }}</td>
                            <td class="sp-small">{{ entry.sp_skill.skill.get_secondary_attribute_display() }}</td>
                            <td class="sp-small">{{ entry.z_spph|commas }}</td>
                            <td class="r sp-time">{{ entry.z_remaining|duration }}</td>
                        {%- endif %}
                        </tr>
                    {%- else %}
                        <tr>
                            <td></td>
                            <td colspan="6">This skill plan is empty.</td>
                        </tr>
                    {%- endfor %}
                    </tbody>
                    {% if entries -%}
                    <tfoot>
                        <tr>
                            <td></td>
                            <td colspan="6" class="r"><strong>Total time remaining</strong>: {{ total_remaining|duration }}</td>
                        </tr>
                    </tfoot>
                    {%- endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="span3">
        <div class="well well-small sidebar-nav" id="skill_list">
            <div class="input-prepend">
                <span class="add-on"><i class="icon-search"></i></span>
                <input id="searchSkill" type="text" placeholder="Search Skill">
            </div>
            {% for market_group, skills in skill_list.items() -%}
            <ul class="nav nav-list ">
                <li class="nav-header collapsed" data-toggle="collapse" data-parent="#skill_list" data-target=".mg-{{ market_group.id }}">
                    <i class="icon-folder-open"></i>
                    {{ market_group.name }}
                </li>
                {% for skill in skills -%}
                <li id="skill-{{ skill.item.id }}" class="mg-{{ market_group.id }} collapse skill" data-name="{{ skill.item.name }}" data-group="{{ market_group.name }}" data-prim="{{ skill.primary_attribute }}" data-sec="{{ skill.secondary_attribute }}" data-planned-to="0" data-skilled-to="0">
                    <a href="#">
                        <span class="skill-hover {{ extra_class}}" rel="popover" title="{{ skill.item.name }}" id="skill-hover-{{ skill.item.id }}" data-content="
                            {{ skill }}
                            <br><br>
                            <strong>Plan to level:</strong> <br>
                            <a href='#' data-level='1' data-id='{{ skill.item.id }}' class='btn btn-small btn-inverse btn-plan-skill'><strong>I</strong></a>&nbsp;
                            <a href='#' data-level='2' data-id='{{ skill.item.id }}' class='btn btn-small btn-inverse btn-plan-skill'><strong>II</strong></a>&nbsp;
                            <a href='#' data-level='3' data-id='{{ skill.item.id }}' class='btn btn-small btn-inverse btn-plan-skill'><strong>III</strong></a>&nbsp;
                            <a href='#' data-level='4' data-id='{{ skill.item.id }}' class='btn btn-small btn-inverse btn-plan-skill'><strong>IV</strong></a>&nbsp;
                            <a href='#' data-level='5' data-id='{{ skill.item.id }}' class='btn btn-small btn-inverse btn-plan-skill'><strong>V</strong></a>">
                            {{ skill.item.name }}{% if level %} {{ level|roman }}{% endif %}
                        </span>
                    </a>
                </li>
                {%- endfor %}  
            </ul>
            {%- endfor %}
        </div>
    </div>       
</div>


{% endblock %}

